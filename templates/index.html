<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISPATCHER.</title>
    <link href="https://fonts.googleapis.com/css2?family=Helvetica+Now:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #000000;
            color: #FFFFFF;
            font-family: 'Helvetica Now', sans-serif;
            margin: 0;
        }
        .app-shell {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .app-container {
            width: 100%;
            max-width: 1200px;
        }
        h1 {
            color: #FF0000;
            font-weight: 800;
            text-align: center;
        }
        h2 {
            color: #FFFFFF;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        footer a {
            color: #FF0000;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        input, textarea, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(39, 39, 39, 0.2);
            color: #FFFFFF;
            border-radius: 0;
            font-family: 'Helvetica Now', sans-serif;
        }
        button {
            background-color: #FF0000;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        button:hover {
            background-color: #CC0000;
        }
        label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .whatsapp-header {
            background-color: #111111;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            margin: 30px auto;
            text-align: center;
        }
        .table-controls {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .table-controls input, .table-controls button, .table-controls label {
            margin: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #FF0000;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #FF0000;
            color: #000000;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tbody tr:nth-child(even) {
            background-color: rgba(255, 0, 0, 0.05);
        }
        tbody tr:hover {
            background-color: rgba(255, 0, 0, 0.12);
        }
        td input, td textarea {
            width: 100%;
            border: none;
            background: transparent;
            color: #FFFFFF;
            outline: none;
            box-shadow: none;
            border-radius: 0;
            padding: 4px 6px;
            box-sizing: border-box;
            margin: 0;
            text-align: center !important;
        }
        .cell-input {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        td input::placeholder,
        td textarea::placeholder {
            text-align: center !important;
        }
        td textarea {
            min-height: 28px;
            height: auto;
            resize: none;
            overflow: hidden;
            line-height: 1.4;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .action-buttons button {
            width: 24px;
            height: 24px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #FFFFFF;
        }
        .action-buttons button:hover {
            color: #FF0000;
        }
        td input:focus, td textarea:focus {
            outline: none;
            box-shadow: inset 0 0 0 1px #FF0000;
        }
        td.selected {
            background-color: rgba(255, 0, 0, 0.25);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
        }
        .status-pending { background: rgba(255,255,255,0.1); color: #e4e4e7; }
        .status-sent { background: rgba(124,252,152,0.2); color: #7CFC98; }
        .status-error { background: rgba(255,77,77,0.2); color: #FF4D4D; }
        .status-skipped { background: rgba(255,255,255,0.08); color: #A1A1AA; }
        .message-editor textarea {
            width: 100%;
            box-sizing: border-box;
        }
        .message-editor {
            background-color: #111111;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            margin: 30px auto;
            text-align: left;
        }
        .file-section textarea {
            width: 100%;
            box-sizing: border-box;
        }
        .file-section {
            background-color: #111111;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            margin: 30px auto;
            text-align: left;
        }
        .file-rows {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .file-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .file-row textarea.link-valid {
            color: #FF0000;
            text-decoration: underline;
        }
        .file-row textarea {
            text-align: left;
            margin: 0;
            padding: 6px 8px;
            min-height: 28px;
            line-height: 1.4;
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .file-row button {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #FFFFFF;
        }
        .file-row button:hover {
            color: #FF0000;
            border-color: rgba(255, 255, 255, 0.3);
        }
        .file-add {
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #FF0000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }
        .file-add:hover {
            background-color: #CC0000;
            color: #FFFFFF;
        }
        .editor-toolbar button {
            margin: 5px;
            padding: 5px 10px;
            background-color: #FF0000;
            color: #FFFFFF;
            border: none;
            cursor: pointer;
        }
        .editor-toolbar button:hover {
            background-color: #CC0000;
        }
        .char-counter {
            font-size: 12px;
            color: #CCCCCC;
        }
        footer {
            text-align: center;
            margin-top: 32px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        footer p {
            margin-bottom: 10px;
        }
        footer .social-icons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 0;
            cursor: pointer;
        }
        footer .social-icons a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }
        footer .social-icons a:hover {
            background-color: rgba(255, 255, 255, 0.16);
            border-color: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }
        footer a {
            color: #FF0000;
            text-decoration: none;
            margin: 0;
            cursor: pointer;
        }
        footer .social-icons a,
        footer .social-icons a i,
        footer .social-icons i,
        footer .social-icons * {
            cursor: pointer;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .header-container {
            margin-top: 0;
            margin-bottom: 48px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .section-header,
        .editor-header {
            text-align: center;
        }
        .symbol {
            width: 0;
            height: 0;
            border-bottom: 64px solid #FF0000;
            border-left: 32px solid transparent;
            border-right: 32px solid transparent;
            margin: 0 auto 24px;
            box-shadow: 0px 0px 20px rgba(255,0,0,0.5);
        }
        h1 {
            font-size: 2.25rem;
            font-weight: bold;
            color: white;
            margin-top: 0;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }
        .dot {
            color: #FF0000;
        }
        .powered-by {
            font-size: 0.875rem;
            color: white;
            text-align: center;
            margin-top: 0;
            margin-bottom: 0;
        }
        .powered-by a {
            color: #FF0000;
            text-decoration: none;
            cursor: pointer;
        }
        .powered-by a:hover {
            text-decoration: underline;
        }
        .powered-by * {
            cursor: pointer;
        }
        .lang-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            background: transparent;
            border: none;
            padding: 0;
            margin-top: 16px;
            cursor: pointer;
            transition: color 0.2s ease;
            text-decoration: none;
        }
        .lang-toggle,
        .lang-toggle:hover,
        .lang-toggle:focus,
        .lang-toggle:active {
            background: transparent;
            border: none;
        }
        .lang-toggle:hover {
            color: #FFFFFF;
        }
        .lang-toggle svg {
            color: #FF0000;
        }
        .lang-toggle:hover svg {
            color: #FF0000;
        }
        .whatsapp-header h2 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        .whatsapp-header p {
            margin-top: 0;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .whatsapp-header button {
            margin-top: 0;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="app-container" style="text-align: left;">
            <div class="header-container">
                <div class="symbol"></div>
                <h1>DISPATCHER<span class="dot">.</span></h1>
                <p class="powered-by">powered by <a href="https://asolfandco.com" target="_blank" rel="noopener noreferrer">Asolf &amp; Co.</a></p>
                <button id="langToggle" class="lang-toggle flex items-center gap-2 text-xs font-bold text-zinc-500 transition-colors uppercase tracking-widest group" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
                        <path d="M2 12h20"></path>
                    </svg>
                    <span>ES</span>
                </button>
            </div>
        
        <div class="whatsapp-header">
            <h2 data-i18n="whatsapp_title">WhatsApp Web</h2>
            <p data-i18n="whatsapp_notice">Can't be embedded here due to security policies.</p>
            <button onclick="openWhatsAppSession()" data-i18n="whatsapp_open">Open WhatsApp Web in a new tab</button>
        </div>

        
        <h2 class="editor-header" data-i18n="message_editor">Message editor</h2>
        <div class="message-editor">
            <div class="editor-toolbar">
                <button onclick="insertFormat('*')" data-i18n="bold">Bold</button>
                <button onclick="insertFormat('_')" data-i18n="italic">Italic</button>
                <button onclick="insertLink()" data-i18n="link">Link</button>
            </div>
            <textarea id="messageEditor" rows="20" placeholder="Type your message here..." data-i18n-placeholder="placeholder_editor"></textarea>
            <div class="char-counter"><span data-i18n="char_count_label">Characters</span>: <span id="editorCharCount">0</span>/4096</div>
        </div>

        <h2 class="editor-header" data-i18n="file_section">Archivo</h2>
        <div class="file-section">
            <div id="fileRows" class="file-rows"></div>
            <button type="button" class="file-add" onclick="addFileRow()"><i class="fas fa-plus"></i> <span data-i18n="add_file">Agregar archivo</span></button>
        </div>

        <div class="section-header">
            <h2 data-i18n="contacts_table">Contacts table</h2>
        </div>
        <div class="table-controls">
            <button onclick="document.getElementById('importFile').click()" data-i18n="import">Import CSV/XLSX</button>
            <input type="file" id="importFile" accept=".csv,.xlsx" onchange="importFile()" style="display: none;">
            <button onclick="exportResults()" data-i18n="export">Export CSV</button>
            <div class="interval-group" style="display:flex;align-items:center;gap:6px;">
                <label for="intervalMin" style="margin:0;" data-i18n="interval_label">Random interval (s):</label>
                <input type="number" id="intervalMin" value="2" min="1" max="10" style="width:60px;">
                <span style="">-</span>
                <input type="number" id="intervalMax" value="4" min="1" max="10" style="width:60px;">
            </div>
            <button onclick="sendAll()" data-i18n="send_all">Send all</button>
        </div>
        <div id="statusBanner" style="display:none;margin:8px auto 0;width:90%;text-align:center;color:#FFFFFF;font-size:0.85rem;"></div>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th data-i18n="country_code">Country code</th>
                    <th data-i18n="phone_number">Phone number</th>
                    <th data-i18n="name">Name</th>
                    <th data-i18n="status">Estado</th>
                    <th data-i18n="actions">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Filas dinámicas -->
                <tr id="addRow">
                    <td colspan="6" style="text-align: center; padding: 10px;">
                        <button type="button" onclick="addSingleRow()"><i class="fas fa-plus"></i> <span data-i18n="add_row">Add row</span></button>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <footer>
            <div class="social-icons">
                <a href="https://www.instagram.com/asolfandco" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/asolfandco" target="_blank"><i class="fab fa-facebook"></i></a>
                <a href="https://www.linkedin.com/company/asolfandco" target="_blank"><i class="fab fa-linkedin"></i></a>
            </div>
        </footer>
        </div>
    </div>
    
    <script>
        const translations = {
            es: {
                title: 'DISPATCHER.',
                whatsapp_title: 'WhatsApp Web',
                whatsapp_notice: 'No puede embeberse aquí por políticas de seguridad. Usa el botón para abrir WhatsApp Web en Chrome for Testing y escanear el QR.',
                whatsapp_open: 'Abrir WhatsApp Web en Chrome for Testing',
                whatsapp_open_session_ok: 'Se abrió la ventana de WhatsApp. Escanea el QR allí.',
                whatsapp_open_session_fail: 'No se pudo abrir la sesión de WhatsApp.',
                contacts_table: 'Tabla de Contactos',
                import: 'Importar CSV/XLSX',
                export: 'Exportar CSV',
                interval_label: 'Intervalo aleatorio (s):',
                send_all: 'Enviar Todo',
                country_code: 'Código de País',
                phone_number: 'Número de Teléfono',
                name: 'Nombre',
                status: 'Estado',
                message: 'Mensaje',
                file_link: 'Archivo (Link)',
                actions: 'Acciones',
                add_row: 'Agregar Fila',
                message_editor: 'Editor de Mensaje',
                file_section: 'Archivo',
                bold: 'Negrita',
                italic: 'Cursiva',
                link: 'Enlace',
                char_count_label: 'Caracteres',
                placeholder_editor: 'Escribe tu mensaje aquí...',
                placeholder_country: 'Ej: 57',
                placeholder_phone: 'Ej: 3001234567',
                placeholder_name: 'Nombre',
                placeholder_message: 'Mensaje',
                placeholder_link: 'https://link.com',
                send: 'Enviar',
                copy: 'Copiar',
                delete: 'Eliminar',
                link_prompt: 'Ingresa la URL:',
                link_text: 'Texto',
                message_required: 'El mensaje es obligatorio.',
                add_file: 'Agregar archivo',
                sending: 'Enviando...',
                sending_in_progress: 'Envío en curso...'
            },
            en: {
                title: 'DISPATCHER.',
                whatsapp_title: 'WhatsApp Web',
                whatsapp_notice: "Can't be embedded here due to security policies. Use the button to open WhatsApp Web in Chrome for Testing and scan the QR.",
                whatsapp_open: 'Open WhatsApp Web in Chrome for Testing',
                whatsapp_open_session_ok: 'WhatsApp window opened. Scan the QR there.',
                whatsapp_open_session_fail: 'Could not open WhatsApp session.',
                contacts_table: 'Contacts table',
                import: 'Import CSV/XLSX',
                export: 'Export CSV',
                interval_label: 'Random interval (s):',
                send_all: 'Send all',
                country_code: 'Country code',
                phone_number: 'Phone number',
                name: 'Name',
                status: 'Status',
                message: 'Message',
                file_link: 'File (link)',
                actions: 'Actions',
                add_row: 'Add row',
                message_editor: 'Message editor',
                file_section: 'File',
                bold: 'Bold',
                italic: 'Italic',
                link: 'Link',
                char_count_label: 'Characters',
                placeholder_editor: 'Type your message here...',
                placeholder_country: 'e.g. 57',
                placeholder_phone: 'e.g. 3001234567',
                placeholder_name: 'Name',
                placeholder_message: 'Message',
                placeholder_link: 'https://link.com',
                send: 'Send',
                copy: 'Copy',
                delete: 'Delete',
                link_prompt: 'Enter the URL:',
                link_text: 'Text',
                message_required: 'Message is required.',
                add_file: 'Add file',
                sending: 'Sending...',
                sending_in_progress: 'Send in progress...'
            }
        };
        let currentLang = 'en';
        let isSending = false;

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function applyTranslations() {
            document.documentElement.lang = currentLang;
            document.title = t('title');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const target = t(el.dataset.i18n);
                const attrs = el.dataset.i18nAttr;
                if (attrs) {
                    attrs.split(',').map(a => a.trim()).filter(Boolean).forEach(attr => {
                        el.setAttribute(attr, target);
                    });
                    return;
                }
                el.textContent = target;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.setAttribute('placeholder', t(el.dataset.i18nPlaceholder));
            });
            const langToggle = document.getElementById('langToggle');
            if (langToggle) {
                const label = langToggle.querySelector('span');
                if (label) {
                    label.textContent = currentLang === 'es' ? 'EN' : 'ES';
                }
            }
        }

        function openWhatsAppSession() {
            fetch('/open_whatsapp', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === 'opened') {
                        alert(t('whatsapp_open_session_ok'));
                    } else {
                        alert(t('whatsapp_open_session_fail'));
                    }
                })
                .catch(() => {
                    alert(t('whatsapp_open_session_fail'));
                });
        }

        function renumberRows() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr')).filter(row => row.id !== 'addRow');
            rows.forEach((row, index) => {
                const cell = row.querySelector('td[data-col="index"]');
                if (cell) cell.textContent = String(index + 1);
                row.dataset.rowIndex = String(index);
            });
        }

        function setRowStatus(row, status, message) {
            if (!row) return;
            const badge = row.querySelector('.status-badge');
            if (!badge) return;
            badge.className = `status-badge status-${status}`;
            badge.textContent = status.toUpperCase();
            if (message) {
                badge.title = message;
            }
        }



        // Contador de caracteres para el editor
        document.getElementById('messageEditor').addEventListener('input', function() {
            document.getElementById('editorCharCount').textContent = this.value.length;
        });

        const langToggleButton = document.getElementById('langToggle');
        if (langToggleButton) {
            langToggleButton.addEventListener('click', () => {
                currentLang = currentLang === 'es' ? 'en' : 'es';
                applyTranslations();
            });
        }
        applyTranslations();
        if (!document.querySelector('#fileRows .file-row')) {
            addFileRow();
        }

        function addFileRow(value = '') {
            const container = document.getElementById('fileRows');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'file-row';
            row.innerHTML = `
                <textarea rows="1" inputmode="url" data-i18n-placeholder="placeholder_link" placeholder="${t('placeholder_link')}">${value}</textarea>
                <button type="button" onclick="removeFileRow(this)" aria-label="${t('delete')}"><i class="fa-regular fa-trash-can"></i></button>
            `;
            container.appendChild(row);
            row.querySelectorAll('textarea').forEach(autoResizeTextarea);
            updateFileLinkStyles(row.querySelector('textarea'));
            applyTranslations();
        }

        function removeFileRow(button) {
            const row = button.closest('.file-row');
            if (row) row.remove();
        }

        function getFileLinks() {
            return Array.from(document.querySelectorAll('#fileRows textarea'))
                .map(field => field.value.trim())
                .filter(Boolean);
        }

        function isLikelyUrl(value) {
            return /^https?:\/\//i.test(value.trim());
        }

        function updateFileLinkStyles(field) {
            if (!field) return;
            if (isLikelyUrl(field.value)) {
                field.classList.add('link-valid');
            } else {
                field.classList.remove('link-valid');
            }
        }

        function showStatus(message, isError = false) {
            const banner = document.getElementById('statusBanner');
            if (!banner) return;
            banner.textContent = message || '';
            banner.style.display = message ? 'block' : 'none';
            banner.style.color = isError ? '#FF4D4D' : '#7CFC98';
        }
        
        function getCellValue(cell) {
            const field = cell.querySelector('textarea, input');
            return field ? field.value : '';
        }

        function addSingleRow() {
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            const row = tbody.insertBefore(document.createElement('tr'), addRow);
            row.innerHTML = `
                <td data-col="index">0</td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}"></textarea></div></td>
                <td><span class="status-badge status-pending">PENDING</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                        <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            row.querySelectorAll('textarea').forEach(autoResizeTextarea);
            applyTranslations();
            renumberRows();
        }
        
        function addRowAfter(button) {
            const currentRow = button.parentElement.parentElement;
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            const newRow = tbody.insertBefore(document.createElement('tr'), addRow);
            newRow.innerHTML = `
                <td data-col="index">0</td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}"></textarea></div></td>
                <td><span class="status-badge status-pending">PENDING</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                        <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            newRow.querySelectorAll('textarea').forEach(autoResizeTextarea);
            applyTranslations();
            renumberRows();
        }
        
        function copyRow(button) {
            const currentRow = button.closest('tr');
            const cells = currentRow.cells;
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            const newRow = tbody.insertBefore(document.createElement('tr'), addRow);
            newRow.innerHTML = `
                <td data-col="index">0</td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true">${getCellValue(cells[1])}</textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true">${getCellValue(cells[2])}</textarea></div></td>
                <td><div class="cell-input"><textarea rows="1">${getCellValue(cells[3])}</textarea></div></td>
                <td><span class="status-badge status-pending">PENDING</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                        <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            newRow.querySelectorAll('textarea').forEach(autoResizeTextarea);
            applyTranslations();
            renumberRows();
        }
        
        function sendFromRow(button) {
            const row = button.closest('tr');
            const cells = row.cells;
            const countryCode = getCellValue(cells[1]);
            const phone = getCellValue(cells[2]);
            const name = getCellValue(cells[3]);
            const message = document.getElementById('messageEditor').value || '';
            const fileLinks = getFileLinks();
            if (!message.trim()) {
                showStatus(t('message_required'), true);
                return;
            }
            setRowStatus(row, 'pending');
            sendMessage(phone, message, fileLinks, countryCode, name, row);
        }
        
        function deleteRow(button) {
            const row = button.closest('tr');
            row.remove();
            renumberRows();
        }
        
        function importFile() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            fetch('/upload', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    populateTable(data.data);
                }
            });
        }
        
        function populateTable(data) {
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            let firstMessage = '';
            let firstFileLink = '';
            // Limpiar filas dinámicas
            while (tbody.firstChild !== addRow) {
                tbody.removeChild(tbody.firstChild);
            }
            data.forEach(item => {
                if (!firstMessage && item.message) {
                    firstMessage = item.message;
                }
                if (!firstFileLink && item.file_link) {
                    firstFileLink = item.file_link;
                }
                const row = tbody.insertBefore(document.createElement('tr'), addRow);
                row.innerHTML = `
                    <td data-col="index">0</td>
                    <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}">${item.country_code || ''}</textarea></div></td>
                    <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}">${item.phone || ''}</textarea></div></td>
                    <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}">${item.name || ''}</textarea></div></td>
                    <td><span class="status-badge status-pending">PENDING</span></td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                            <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                            <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
                row.querySelectorAll('textarea').forEach(autoResizeTextarea);
            });
            const editor = document.getElementById('messageEditor');
            if (editor && !editor.value && firstMessage) {
                editor.value = firstMessage;
                document.getElementById('editorCharCount').textContent = editor.value.length;
            }
            const fileContainer = document.getElementById('fileRows');
            if (fileContainer && !fileContainer.children.length) {
                addFileRow(firstFileLink || '');
            }
            applyTranslations();
            renumberRows();
        }
        
        function sendAll() {
            if (isSending) {
                showStatus(t('sending_in_progress'), true);
                return;
            }
            const rows = Array.from(document.querySelectorAll('#tableBody tr')).filter(row => row.id !== 'addRow');
            const contacts = rows.map(row => {
                const cells = row.cells;
                const countryCode = getCellValue(cells[1]);
                const phone = getCellValue(cells[2]);
                const name = getCellValue(cells[3]);
                return {
                    row_index: row.dataset.rowIndex ? parseInt(row.dataset.rowIndex, 10) : null,
                    country_code: countryCode,
                    phone: phone,
                    name: name
                };
            }).filter(contact => contact.phone);
            rows.forEach(row => setRowStatus(row, 'pending'));

            const message = document.getElementById('messageEditor').value || '';
            const fileLinks = getFileLinks();
            if (!message.trim()) {
                showStatus(t('message_required'), true);
                return;
            }
            
            const minInterval = parseInt(document.getElementById('intervalMin').value);
            const maxInterval = parseInt(document.getElementById('intervalMax').value);
            
            isSending = true;
            showStatus(t('sending'), false);
            fetch('/send_all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contacts, message, fileLinks, min_interval: minInterval, max_interval: maxInterval })
            })
            .then(async response => {
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) { data = { error: text || 'Server error' }; }
                if (!response.ok && !data.error) {
                    data.error = `HTTP ${response.status}`;
                }
                return data;
            })
            .then(data => {
                if (data.error) {
                    showStatus(data.error, true);
                } else {
                    showStatus(data.status || 'OK', false);
                    if (Array.isArray(data.results)) {
                        data.results.forEach(result => {
                            if (result.row_index === null || result.row_index === undefined) return;
                            const row = rows.find(r => parseInt(r.dataset.rowIndex, 10) === result.row_index);
                            if (row) {
                                setRowStatus(row, result.status || 'pending', result.error);
                            }
                        });
                    }
                }
            })
            .catch(() => {
                showStatus('No se pudo conectar con el servidor.', true);
            })
            .finally(() => {
                isSending = false;
            });
        }
        
        function insertFormat(format) {
            const textarea = document.getElementById('messageEditor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            const before = text.substring(0, start);
            const selected = text.substring(start, end);
            const after = text.substring(end);

            const hasWrapping =
                start >= format.length &&
                end + format.length <= text.length &&
                text.substring(start - format.length, start) === format &&
                text.substring(end, end + format.length) === format;

            if (hasWrapping) {
                textarea.value =
                    text.substring(0, start - format.length) +
                    selected +
                    text.substring(end + format.length);
                textarea.focus();
                textarea.setSelectionRange(start - format.length, end - format.length);
            } else {
                const formatted = `${format}${selected}${format}`;
                textarea.value = before + formatted + after;
                textarea.focus();
                textarea.setSelectionRange(start + format.length, end + format.length);
            }

            document.getElementById('editorCharCount').textContent = textarea.value.length;
        }
        
        function insertLink() {
            const url = prompt(t('link_prompt'));
            if (url) {
                const textarea = document.getElementById('messageEditor');
                const start = textarea.selectionStart;
                const text = textarea.value;
                const linkText = `[${t('link_text')}](${url})`;
                textarea.value = text.substring(0, start) + linkText + text.substring(start);
                textarea.focus();
                document.getElementById('editorCharCount').textContent = textarea.value.length;
            }
        }
        
        function sendMessage(phone, message, fileLinks, countryCode, name, row) {
            if (isSending) {
                showStatus(t('sending_in_progress'), true);
                return;
            }
            isSending = true;
            showStatus(t('sending'), false);
            fetch('/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, message, fileLinks, country_code: countryCode, name, row_index: row ? parseInt(row.dataset.rowIndex, 10) : null })
            })
            .then(async response => {
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) { data = { error: text || 'Server error' }; }
                if (!response.ok && !data.error) {
                    data.error = `HTTP ${response.status}`;
                }
                return data;
            })
            .then(data => {
                if (data.error) {
                    showStatus(data.error, true);
                    if (row) setRowStatus(row, 'error', data.error);
                } else {
                    showStatus(data.status || 'OK', false);
                    if (row) setRowStatus(row, 'sent');
                }
            })
            .catch(() => {
                showStatus('No se pudo conectar con el servidor.', true);
            })
            .finally(() => {
                isSending = false;
            });
        }
        
        function exportResults() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr')).filter(row => row.id !== 'addRow');
            const headers = [
                t('country_code'),
                t('phone_number'),
                t('name')
            ];
            let csv = `${headers.join(',')}\n`;
            rows.forEach(row => {
                const cells = row.cells;
                if (!cells || cells.length < 4) return;
                const countryCode = getCellValue(cells[1]);
                const phone = getCellValue(cells[2]);
                const name = getCellValue(cells[3]);
                csv += `"${countryCode}","${phone}","${name}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contacts.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
        
        function openWhatsApp() {
            window.open('https://web.whatsapp.com', '_blank');
        }

        const tableBody = document.getElementById('tableBody');
        let isDragging = false;
        let anchorCell = null;

        function getCellCoords(cell) {
            const row = cell.parentElement;
            const rows = Array.from(tableBody.querySelectorAll('tr')).filter(r => r.id !== 'addRow');
            const rowIndex = rows.indexOf(row);
            const colIndex = Array.from(row.children).indexOf(cell);
            return { rowIndex, colIndex };
        }

        function getCellAt(rowIndex, colIndex) {
            const rows = Array.from(tableBody.querySelectorAll('tr')).filter(r => r.id !== 'addRow');
            if (rowIndex < 0 || rowIndex >= rows.length) return null;
            const cells = rows[rowIndex].children;
            if (colIndex < 0 || colIndex >= cells.length) return null;
            return cells[colIndex];
        }

        function clearSelection() {
            tableBody.querySelectorAll('td.selected').forEach(cell => cell.classList.remove('selected'));
        }

        function selectRange(fromCell, toCell) {
            clearSelection();
            if (!fromCell || !toCell) return;
            const from = getCellCoords(fromCell);
            const to = getCellCoords(toCell);
            const rMin = Math.min(from.rowIndex, to.rowIndex);
            const rMax = Math.max(from.rowIndex, to.rowIndex);
            const cMin = Math.min(from.colIndex, to.colIndex);
            const cMax = Math.max(from.colIndex, to.colIndex);
            for (let r = rMin; r <= rMax; r += 1) {
                for (let c = cMin; c <= cMax; c += 1) {
                    const cell = getCellAt(r, c);
                    if (cell) cell.classList.add('selected');
                }
            }
        }

        tableBody.addEventListener('mousedown', (event) => {
            if (event.target.closest('input, textarea')) {
                return;
            }
            const cell = event.target.closest('td');
            if (!cell || cell.parentElement.id === 'addRow') return;
            isDragging = true;
            if (event.shiftKey && anchorCell) {
                selectRange(anchorCell, cell);
            } else {
                anchorCell = cell;
                selectRange(cell, cell);
            }
        });

        tableBody.addEventListener('mouseover', (event) => {
            if (!isDragging) return;
            const cell = event.target.closest('td');
            if (!cell || cell.parentElement.id === 'addRow') return;
            selectRange(anchorCell, cell);
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        async function copySelectionToClipboard() {
            const selected = Array.from(tableBody.querySelectorAll('td.selected'));
            if (selected.length === 0) return;
            const coords = selected.map(getCellCoords);
            const rMin = Math.min(...coords.map(c => c.rowIndex));
            const rMax = Math.max(...coords.map(c => c.rowIndex));
            const cMin = Math.min(...coords.map(c => c.colIndex));
            const cMax = Math.max(...coords.map(c => c.colIndex));
            const lines = [];
            for (let r = rMin; r <= rMax; r += 1) {
                const rowVals = [];
                for (let c = cMin; c <= cMax; c += 1) {
                    const cell = getCellAt(r, c);
                    if (!cell) {
                        rowVals.push('');
                        continue;
                    }
                    const input = cell.querySelector('input, textarea');
                    rowVals.push(input ? input.value : cell.textContent.trim());
                }
                lines.push(rowVals.join('\t'));
            }
            const text = lines.join('\n');
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                textarea.remove();
            }
        }

        async function pasteFromClipboard() {
            if (!anchorCell) return;
            let text = '';
            if (navigator.clipboard && navigator.clipboard.readText) {
                text = await navigator.clipboard.readText();
            }
            if (!text) return;
            const rows = text.split(/\r?\n/);
            const start = getCellCoords(anchorCell);
            rows.forEach((rowText, rIndex) => {
                const cols = rowText.split('\t');
                cols.forEach((val, cIndex) => {
                    const cell = getCellAt(start.rowIndex + rIndex, start.colIndex + cIndex);
                    if (!cell) return;
                    const input = cell.querySelector('input, textarea');
                    if (input) input.value = val;
                });
            });
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }

        document.addEventListener('input', (event) => {
            const textarea = event.target.closest('textarea');
            if (textarea && textarea.closest('#dataTable')) {
                autoResizeTextarea(textarea);
            }
        });

        document.addEventListener('input', (event) => {
            const textarea = event.target.closest('#fileRows textarea');
            if (!textarea) return;
            autoResizeTextarea(textarea);
        });

        document.addEventListener('input', (event) => {
            const field = event.target.closest('#fileRows textarea');
            if (!field) return;
            updateFileLinkStyles(field);
        });

        document.querySelectorAll('#dataTable textarea').forEach(autoResizeTextarea);

        document.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c') {
                copySelectionToClipboard();
            }
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'v') {
                pasteFromClipboard();
            }
        });

        document.addEventListener('input', (event) => {
            const field = event.target.closest('textarea[data-numeric="true"]');
            if (!field) return;
            const cleaned = field.value.replace(/\D+/g, '');
            if (cleaned !== field.value) {
                const pos = field.selectionStart;
                field.value = cleaned;
                field.setSelectionRange(Math.min(pos, cleaned.length), Math.min(pos, cleaned.length));
            }
        });
    </script>
</body>
</html>
