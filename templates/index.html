<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISPATCHER.</title>
    <link href="https://fonts.googleapis.com/css2?family=Helvetica+Now:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #000000;
            color: #FFFFFF;
            font-family: 'Helvetica Now', sans-serif;
            margin: 0;
        }
        .app-shell {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .app-container {
            width: 100%;
            max-width: 1200px;
        }
        h1 {
            color: #FF0000;
            font-weight: 800;
            text-align: center;
        }
        h2 {
            color: #FFFFFF;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        footer a {
            color: #FF0000;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        input, textarea, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(39, 39, 39, 0.2);
            color: #FFFFFF;
            border-radius: 0;
            font-family: 'Helvetica Now', sans-serif;
        }
        button {
            background-color: #FF0000;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        button:hover {
            background-color: #CC0000;
        }
        label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .whatsapp-header {
            background-color: #111111;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            margin: 30px auto;
            text-align: center;
        }
        .whatsapp-header.loading #whatsappOpenBtn {
            display: none !important;
            visibility: hidden !important;
        }
        .table-controls {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .table-controls .bulk-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .table-controls input, .table-controls button, .table-controls label {
            margin: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #FF0000;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        .row-select {
            width: 16px;
            height: 16px;
            accent-color: #FF0000;
        }
        th {
            background-color: #FF0000;
            color: #000000;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tbody tr:nth-child(even) {
            background-color: rgba(255, 0, 0, 0.05);
        }
        tbody tr:hover {
            background-color: rgba(255, 0, 0, 0.12);
        }
        td input, td textarea {
            width: 100%;
            border: none;
            background: transparent;
            color: #FFFFFF;
            outline: none;
            box-shadow: none;
            border-radius: 0;
            padding: 4px 6px;
            box-sizing: border-box;
            margin: 0;
            text-align: center !important;
        }
        .cell-input {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        td input::placeholder,
        td textarea::placeholder {
            text-align: center !important;
        }
        td textarea {
            min-height: 28px;
            height: auto;
            resize: none;
            overflow: hidden;
            line-height: 1.4;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .action-buttons button {
            width: 24px;
            height: 24px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #FFFFFF;
        }
        .action-buttons button:hover {
            color: #FF0000;
        }
        td input:focus, td textarea:focus {
            outline: none;
            box-shadow: inset 0 0 0 1px #FF0000;
        }
        td.selected {
            background-color: rgba(255, 0, 0, 0.25);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
        }
        .status-pending { background: rgba(255,255,255,0.1); color: #e4e4e7; }
        .status-sent { background: rgba(124,252,152,0.2); color: #7CFC98; }
        .status-error { background: rgba(255,77,77,0.2); color: #FF4D4D; }
        .status-skipped { background: rgba(255,255,255,0.08); color: #A1A1AA; }
        .status-loading::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: -2px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .message-editor textarea {
            width: 100%;
            box-sizing: border-box;
        }
        .message-editor {
            background-color: #111111;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            margin: 30px auto;
            text-align: left;
        }
        .history-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .history-actions button {
            min-width: 44px;
        }
        .editor-toolbar button {
            margin: 5px;
            padding: 5px 10px;
            background-color: #FF0000;
            color: #FFFFFF;
            border: none;
            cursor: pointer;
        }
        .editor-toolbar button:hover {
            background-color: #CC0000;
        }
        .char-counter {
            font-size: 12px;
            color: #CCCCCC;
        }
        footer {
            text-align: center;
            margin-top: 32px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        footer p {
            margin-bottom: 10px;
        }
        footer .social-icons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 0;
            cursor: pointer;
        }
        footer .social-icons a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }
        footer .social-icons a:hover {
            background-color: rgba(255, 255, 255, 0.16);
            border-color: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }
        footer a {
            color: #FF0000;
            text-decoration: none;
            margin: 0;
            cursor: pointer;
        }
        footer .social-icons a,
        footer .social-icons a i,
        footer .social-icons i,
        footer .social-icons * {
            cursor: pointer;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .header-container {
            margin-top: 0;
            margin-bottom: 48px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .section-header,
        .editor-header {
            text-align: center;
        }
        .symbol {
            width: 0;
            height: 0;
            border-bottom: 64px solid #FF0000;
            border-left: 32px solid transparent;
            border-right: 32px solid transparent;
            margin: 0 auto 24px;
            box-shadow: 0px 0px 20px rgba(255,0,0,0.5);
        }
        h1 {
            font-size: 2.25rem;
            font-weight: bold;
            color: white;
            margin-top: 0;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }
        .dot {
            color: #FF0000;
        }
        .powered-by {
            font-size: 0.875rem;
            color: white;
            text-align: center;
            margin-top: 0;
            margin-bottom: 0;
        }
        .powered-by a {
            color: #FF0000;
            text-decoration: none;
            cursor: pointer;
        }
        .powered-by a:hover {
            text-decoration: underline;
        }
        .powered-by * {
            cursor: pointer;
        }
        .lang-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            background: transparent;
            border: none;
            padding: 0;
            margin-top: 16px;
            cursor: pointer;
            transition: color 0.2s ease;
            text-decoration: none;
        }
        .lang-toggle,
        .lang-toggle:hover,
        .lang-toggle:focus,
        .lang-toggle:active {
            background: transparent;
            border: none;
        }
        .lang-toggle:hover {
            color: #FFFFFF;
        }
        .lang-toggle svg {
            color: #FF0000;
        }
        .lang-toggle:hover svg {
            color: #FF0000;
        }
        .status-inline {
            margin-top: 6px;
            font-size: 0.85rem;
            color: #A1A1AA;
            min-height: 14px;
            display: block;
            text-align: center;
            line-height: 1.2;
        }
        #whatsappStatus {
            width: 100%;
            text-align: center;
        }
        .whatsapp-header #whatsappOpenBtn + #whatsappStatus {
            margin-top: 0;
        }
        .status-inline.loading::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: -2px;
        }
        .whatsapp-header h2 {
            margin-top: 0;
            margin-bottom: 12px;
        }
        .whatsapp-header p {
            margin-top: 0;
            margin-bottom: 12px;
            text-align: center;
        }
        .whatsapp-header button {
            margin-top: 0;
            margin-bottom: 0;
        }
        .is-hidden {
            display: none !important;
            visibility: hidden !important;
        }
        #statusBanner {
            display: none;
            margin: 12px auto 0;
            width: 100%;
            text-align: center;
            color: #FFFFFF;
            font-size: 0.85rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="app-container" style="text-align: left;">
            <div class="header-container">
                <div class="symbol"></div>
                <h1>DISPATCHER<span class="dot">.</span></h1>
                <p class="powered-by">powered by <a href="https://asolfandco.com" target="_blank" rel="noopener noreferrer">Asolf &amp; Co.</a></p>
                <button id="langToggle" class="lang-toggle flex items-center gap-2 text-xs font-bold text-zinc-500 transition-colors uppercase tracking-widest group" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
                        <path d="M2 12h20"></path>
                    </svg>
                    <span>ES</span>
                </button>
            </div>
        
        <div class="whatsapp-header">
            <h2 data-i18n="whatsapp_title">WhatsApp Web</h2>
            <p data-i18n="whatsapp_notice">Can't be embedded here due to security policies.</p>
            <button id="whatsappOpenBtn" type="button" onclick="openWhatsAppSession()" data-i18n="whatsapp_open">Open WhatsApp Web in a new tab</button>
            <div id="whatsappStatus" class="status-inline" aria-live="polite"></div>
        </div>

        
        <h2 class="editor-header" data-i18n="message_editor">Message editor</h2>
        <div class="message-editor">
            <div class="editor-toolbar">
                <button onclick="insertFormat('*')" data-i18n="bold">Bold</button>
                <button onclick="insertFormat('_')" data-i18n="italic">Italic</button>
                <button onclick="insertFormat('~')" data-i18n="strike">Strike</button>
                <button onclick="insertFormat('`')" data-i18n="mono">Mono</button>
                <button onclick="insertNameToken()" data-i18n="name_token">Name</button>
            </div>
            <textarea id="messageEditor" rows="20" placeholder="Type your message here..." data-i18n-placeholder="placeholder_editor"></textarea>
            <div class="char-counter"><span data-i18n="char_count_label">Characters</span>: <span id="editorCharCount">0</span>/4096</div>
        </div>

        <div class="section-header">
            <h2 data-i18n="contacts_table">Contacts table</h2>
        </div>
        <div class="table-controls">
            <button onclick="document.getElementById('importFile').click()" data-i18n="import">Import CSV/XLSX</button>
            <input type="file" id="importFile" accept=".csv,.xlsx" onchange="importFile()" style="display: none;">
            <button onclick="exportResults()" data-i18n="export">Export CSV</button>
            <div class="history-actions">
                <button type="button" id="undoBtn" onclick="undoAction()" data-i18n="undo" data-i18n-attr="title,aria-label" title="Undo" aria-label="Undo"><i class="fa-solid fa-rotate-left"></i></button>
                <button type="button" id="redoBtn" onclick="redoAction()" data-i18n="redo" data-i18n-attr="title,aria-label" title="Redo" aria-label="Redo"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="bulk-actions">
                <button type="button" onclick="copyAllRows()" data-i18n="copy_all">Duplicate</button>
                <button type="button" onclick="deleteAllRows()" data-i18n="delete_all">Delete all</button>
            </div>
            <div class="interval-group" style="display:flex;align-items:center;gap:6px;">
                <label for="intervalMin" style="margin:0;" data-i18n="interval_label">Random interval (s):</label>
                <input type="number" id="intervalMin" value="1" min="1" max="10" style="width:60px;">
                <span style="">-</span>
                <input type="number" id="intervalMax" value="2" min="1" max="10" style="width:60px;">
            </div>
            <button onclick="sendAll()" data-i18n="send_all">Send all</button>
        </div>
        <div id="statusBanner"></div>
        <table id="dataTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllRows" class="row-select" aria-label="Select all" /></th>
                    <th>#</th>
                    <th data-i18n="country_code">Country code</th>
                    <th data-i18n="phone_number">Phone number</th>
                    <th data-i18n="name">Name</th>
                    <th data-i18n="status">Estado</th>
                    <th data-i18n="actions">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Filas dinámicas -->
                <tr id="addRow">
                    <td colspan="7" style="text-align: center; padding: 10px;">
                        <button type="button" onclick="addSingleRow()"><i class="fas fa-plus"></i> <span data-i18n="add_row">Add row</span></button>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <footer>
            <div class="social-icons">
                <a href="https://www.instagram.com/asolfandco" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/asolfandco" target="_blank"><i class="fab fa-facebook"></i></a>
                <a href="https://www.linkedin.com/company/asolfandco" target="_blank"><i class="fab fa-linkedin"></i></a>
            </div>
        </footer>
        </div>
    </div>
    
    <script>
        const translations = {
            es: {
                title: 'DISPATCHER.',
                whatsapp_title: 'WhatsApp Web',
                whatsapp_notice: 'Abre WhatsApp Web solo con el botón de abajo.',
                whatsapp_open: 'Abrir',
                whatsapp_opening: 'Abriendo WhatsApp Web...',
                whatsapp_open_session_ok: 'Se abrió la ventana de WhatsApp. Escanea el QR allí.',
                whatsapp_open_session_fail: 'No se pudo abrir la sesión de WhatsApp.',
                status: 'Estado',
                status_pending: 'Pendiente',
                status_sent: 'Enviado',
                status_error: 'Error',
                status_skipped: 'Omitido',
                contacts_table: 'Tabla de Contactos',
                import: 'Importar CSV/XLSX',
                export: 'Exportar CSV',
                select_all: 'Seleccionar todo',
                copy_all: 'Copiar',
                delete_all: 'Eliminar',
                undo: 'Deshacer',
                redo: 'Rehacer',
                interval_label: 'Intervalo aleatorio (s):',
                send_all: 'Enviar Todo',
                country_code: 'Código de País',
                phone_number: 'Número de Teléfono',
                name: 'Nombre',
                status: 'Estado',
                message: 'Mensaje',
                file_link: 'Archivo (Link)',
                actions: 'Acciones',
                add_row: 'Agregar Fila',
                message_editor: 'Editor de Mensaje',
                file_section: 'Archivo',
                bold: 'Negrita',
                italic: 'Cursiva',
                strike: 'Tachado',
                mono: 'Monoespaciado',
                name_token: 'Nombre',
                char_count_label: 'Caracteres',
                placeholder_editor: 'Escribe tu mensaje aquí...',
                placeholder_country: 'Ej: 57',
                placeholder_phone: 'Ej: 3001234567',
                placeholder_name: 'Nombre',
                placeholder_message: 'Mensaje',
                placeholder_link: 'https://link.com',
                send: 'Enviar',
                copy: 'Duplicar',
                copy_all: 'Duplicar',
                delete: 'Eliminar',
                message_required: 'El mensaje es obligatorio.',
                error_message_required: 'El mensaje es obligatorio.',
                error_phone_message_required: 'Teléfono y mensaje son obligatorios.',
                error_whatsapp_not_authenticated: 'WhatsApp no está autenticado. Abre WhatsApp Web y escanea el QR.',
                error_attach_files: 'No se pudieron adjuntar los archivos.',
                error_send_attachments: 'No se pudo enviar los adjuntos.',
                error_send_message: 'No se pudo enviar el mensaje.',
                error_whatsapp_open_failed: 'No se pudo abrir la sesión de WhatsApp.',
                error_connect: 'No se pudo conectar con el servidor.',
                add_file: 'Agregar archivos',
                add_folder: 'Agregar carpeta',
                file_uploading: 'Cargando',
                file_ready: 'Cargado',
                file_status_loading: 'Cargando',
                file_status_loaded: 'Cargado',
                file_status_error: 'Error',
                sending: 'Enviando...',
                sending_in_progress: 'Envío en curso...',
                send_summary: 'Enviados: {sent} · Errores: {error} · Omitidos: {skipped}',
                of: 'de'
            },
            en: {
                title: 'DISPATCHER.',
                whatsapp_title: 'WhatsApp Web',
                whatsapp_notice: 'Open WhatsApp Web using the button below.',
                whatsapp_open: 'Open',
                whatsapp_opening: 'Opening WhatsApp Web...',
                whatsapp_open_session_ok: 'WhatsApp window opened. Scan the QR code there.',
                whatsapp_open_session_fail: 'Couldn\'t open WhatsApp session.',
                status: 'Status',
                status_pending: 'Pending',
                status_sent: 'Sent',
                status_error: 'Error',
                status_skipped: 'Skipped',
                contacts_table: 'Contacts table',
                import: 'Import CSV/XLSX',
                export: 'Export CSV',
                select_all: 'Select all',
                copy_all: 'Duplicate',
                delete_all: 'Delete',
                undo: 'Undo',
                redo: 'Redo',
                interval_label: 'Random interval (s):',
                send_all: 'Send all',
                country_code: 'Country code',
                phone_number: 'Phone number',
                name: 'Name',
                status: 'Status',
                message: 'Message',
                file_link: 'File (link)',
                actions: 'Actions',
                add_row: 'Add row',
                message_editor: 'Message editor',
                file_section: 'Files',
                bold: 'Bold',
                italic: 'Italic',
                strike: 'Strikethrough',
                mono: 'Monospace',
                name_token: 'Name',
                char_count_label: 'Characters',
                placeholder_editor: 'Type your message here...',
                placeholder_country: 'e.g. 57',
                placeholder_phone: 'e.g. 3001234567',
                placeholder_name: 'Name',
                placeholder_message: 'Message',
                placeholder_link: 'https://link.com',
                send: 'Send',
                copy: 'Duplicate',
                delete: 'Delete',
                message_required: 'Message is required.',
                error_message_required: 'Message is required.',
                error_phone_message_required: 'Phone and message are required.',
                error_whatsapp_not_authenticated: 'WhatsApp is not authenticated. Open WhatsApp Web and scan the QR.',
                error_attach_files: 'Files could not be attached.',
                error_send_attachments: 'Could not send attachments.',
                error_send_message: 'Could not send the message.',
                error_whatsapp_open_failed: 'Could not open WhatsApp session.',
                error_connect: 'Could not connect to the server.',
                add_file: 'Add files',
                add_folder: 'Add folder',
                file_uploading: 'Uploading',
                file_ready: 'Ready',
                file_status_loading: 'Loading',
                file_status_loaded: 'Loaded',
                file_status_error: 'Error',
                sending: 'Sending...',
                sending_in_progress: 'Sending in progress...',
                send_summary: 'Sent: {sent} · Errors: {error} · Skipped: {skipped}',
                of: 'of'
            }
        };
        let currentLang = 'en';
        let isSending = false;

        const tableBody = document.getElementById('tableBody');
        const selectAllRowsCheckbox = document.getElementById('selectAllRows');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const messageEditor = document.getElementById('messageEditor');
        const fileRowsContainer = document.getElementById('fileRows');

        const tableHistory = [];
        let historyIndex = -1;
        let historyTimer = null;
        let isRestoringHistory = false;

        const messageHistory = [];
        let messageHistoryIndex = -1;
        let messageHistoryTimer = null;
        let isRestoringMessage = false;

        const fileHistory = [];
        let fileHistoryIndex = -1;
        let fileHistoryTimer = null;
        let isRestoringFiles = false;
        const fileStore = new Map();
        let selectedFileIds = [];

        let activeArea = 'table';
        let isDragging = false;
        let anchorCell = null;

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function applyTranslations() {
            document.documentElement.lang = currentLang;
            document.title = t('title');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const target = t(el.dataset.i18n);
                const attrs = el.dataset.i18nAttr;
                if (attrs) {
                    attrs.split(',').map(a => a.trim()).filter(Boolean).forEach(attr => {
                        el.setAttribute(attr, target);
                    });
                    return;
                }
                el.textContent = target;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.setAttribute('placeholder', t(el.dataset.i18nPlaceholder));
            });
            const langToggle = document.getElementById('langToggle');
            if (langToggle) {
                const label = langToggle.querySelector('span');
                if (label) {
                    label.textContent = currentLang === 'es' ? 'EN' : 'ES';
                }
            }
            document.querySelectorAll('.status-badge').forEach(badge => {
                const status = badge.dataset.status || 'pending';
                const label = t(`status_${status}`);
                badge.textContent = label || status.toUpperCase();
            });
            if (typeof renderFileList === 'function') {
                renderFileList();
            }
        }

        function openWhatsAppSession() {
            const whatsappStatus = document.getElementById('whatsappStatus');
            const whatsappOpenBtn = document.getElementById('whatsappOpenBtn');
            const whatsappHeader = document.querySelector('.whatsapp-header');
            if (whatsappStatus) {
                whatsappStatus.textContent = t('whatsapp_opening');
                whatsappStatus.classList.add('loading');
            }
            if (whatsappHeader) {
                whatsappHeader.classList.add('loading');
            }
            if (whatsappOpenBtn) {
                whatsappOpenBtn.disabled = true;
            }
            showStatus(t('whatsapp_opening'), false, true);
            fetch('/open_whatsapp', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data && data.status === 'opened') {
                        if (whatsappStatus) {
                            whatsappStatus.textContent = t('whatsapp_open_session_ok');
                            whatsappStatus.classList.remove('loading');
                        }
                        if (whatsappHeader) {
                            whatsappHeader.classList.remove('loading');
                        }
                        if (whatsappOpenBtn) {
                            whatsappOpenBtn.classList.add('is-hidden');
                            whatsappOpenBtn.disabled = true;
                            whatsappOpenBtn.setAttribute('aria-hidden', 'true');
                        }
                        showStatus(t('whatsapp_open_session_ok'), false);
                    } else {
                        const message = data?.error_code ? t(data.error_code) : t('whatsapp_open_session_fail');
                        if (whatsappStatus) {
                            whatsappStatus.textContent = message;
                            whatsappStatus.classList.remove('loading');
                        }
                        if (whatsappHeader) {
                            whatsappHeader.classList.remove('loading');
                        }
                        if (whatsappOpenBtn) {
                            whatsappOpenBtn.disabled = false;
                        }
                        showStatus(message, true);
                    }
                })
                .catch(() => {
                    if (whatsappStatus) {
                        whatsappStatus.textContent = t('whatsapp_open_session_fail');
                        whatsappStatus.classList.remove('loading');
                    }
                    if (whatsappHeader) {
                        whatsappHeader.classList.remove('loading');
                    }
                    if (whatsappOpenBtn) {
                        whatsappOpenBtn.disabled = false;
                    }
                    showStatus(t('whatsapp_open_session_fail'), true);
                });
        }

        function renumberRows() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr')).filter(row => row.id !== 'addRow');
            rows.forEach((row, index) => {
                const cell = row.querySelector('td[data-col="index"]');
                if (cell) cell.textContent = String(index + 1);
                row.dataset.rowIndex = String(index);
            });
        }

        function setRowStatus(row, status, message) {
            if (!row) return;
            const badge = row.querySelector('.status-badge');
            if (!badge) return;
            badge.className = `status-badge status-${status}`;
            badge.dataset.status = status;
            const label = t(`status_${status}`);
            badge.textContent = label || status.toUpperCase();
            if (message) {
                badge.title = message;
            }
        }



        // Contador de caracteres para el editor
        document.getElementById('messageEditor').addEventListener('input', function() {
            document.getElementById('editorCharCount').textContent = this.value.length;
            scheduleMessageHistory();
        });

        const langToggleButton = document.getElementById('langToggle');
        if (langToggleButton) {
            langToggleButton.addEventListener('click', () => {
                currentLang = currentLang === 'es' ? 'en' : 'es';
                applyTranslations();
            });
        }
        applyTranslations();

        function addFileRow(value = '') {
            return;
        }

        function removeFileRow(button) {
            return;
        }

        function handleFilePick(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;
            activeArea = 'files';
            updateHistoryButtons();
            files.forEach(file => {
                const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
                fileStore.set(id, { file, status: 'loading', progress: 0 });
                selectedFileIds.push(id);
                const reader = new FileReader();
                reader.onprogress = (evt) => {
                    if (!evt.lengthComputable) return;
                    const percent = Math.min(100, Math.round((evt.loaded / evt.total) * 100));
                    updateFileEntry(id, { progress: percent });
                };
                reader.onload = () => {
                    updateFileEntry(id, { progress: 100, status: 'loaded' });
                };
                reader.onerror = () => {
                    updateFileEntry(id, { progress: 0, status: 'error' });
                };
                reader.readAsArrayBuffer(file);
            });
            event.target.value = '';
            renderFileList();
            if (!isRestoringFiles) {
                scheduleFileHistory();
            }
        }

        function updateFileEntry(id, updates) {
            const entry = fileStore.get(id);
            if (!entry) return;
            fileStore.set(id, { ...entry, ...updates });
            renderFileList();
        }

        function renderFileList() {
            if (!fileRowsContainer) return;
            fileRowsContainer.innerHTML = '';
            if (!selectedFileIds.length) return;
            selectedFileIds.forEach(id => {
                const entry = fileStore.get(id);
                if (!entry) return;
                const file = entry.file;
                const displayName = file.webkitRelativePath || file.name;
                const statusLabel = getFileStatusLabel(entry.status);
                const progressValue = typeof entry.progress === 'number' ? entry.progress : 0;
                const row = document.createElement('div');
                row.className = 'file-row';
                row.innerHTML = `
                    <div class="file-meta">
                        <span class="file-name">${displayName}</span>
                        <div class="file-progress"><div class="file-progress-bar" style="width: ${progressValue}%"></div></div>
                        <span class="file-status ${entry.status}">${statusLabel}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    </div>
                    <button type="button" onclick="removeFileById('${id}')" aria-label="${t('delete')}"><i class="fa-regular fa-trash-can"></i></button>
                `;
                fileRowsContainer.appendChild(row);
            });
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 KB';
            const kb = bytes / 1024;
            if (kb < 1024) return `${Math.ceil(kb)} KB`;
            const mb = kb / 1024;
            return `${mb.toFixed(1)} MB`;
        }

        function getFileStatusLabel(status) {
            const key = status === 'loaded'
                ? 'file_status_loaded'
                : status === 'error'
                    ? 'file_status_error'
                    : 'file_status_loading';
            return t(key);
        }

        function removeFileById(id) {
            selectedFileIds = selectedFileIds.filter(entry => entry !== id);
            renderFileList();
            if (!isRestoringFiles) {
                scheduleFileHistory();
            }
        }

        function getSelectedFiles() {
            return selectedFileIds
                .map(id => fileStore.get(id))
                .filter(Boolean)
                .map(entry => entry.file);
        }

        function showStatus(message, isError = false, isLoading = false) {
            const banner = document.getElementById('statusBanner');
            if (!banner) return;
            banner.textContent = message || '';
            banner.style.display = message ? 'block' : 'none';
            banner.style.color = isError ? '#FF4D4D' : '#7CFC98';
            banner.classList.toggle('status-loading', isLoading);
        }

        function localizeError(data) {
            if (data && data.error_code) {
                return t(data.error_code);
            }
            if (data && data.error && translations[currentLang][data.error]) {
                return t(data.error);
            }
            return data?.error || t('error_connect');
        }

        function formatSendSummary(results) {
            const counts = { sent: 0, error: 0, skipped: 0 };
            results.forEach(result => {
                const status = (result.status || '').toLowerCase();
                if (status === 'sent') counts.sent += 1;
                else if (status === 'error') counts.error += 1;
                else counts.skipped += 1;
            });
            return t('send_summary')
                .replace('{sent}', counts.sent)
                .replace('{error}', counts.error)
                .replace('{skipped}', counts.skipped);
        }
        
        function getCellValue(cell) {
            const field = cell.querySelector('textarea, input');
            return field ? field.value : '';
        }

        function addSingleRow() {
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            const row = tbody.insertBefore(document.createElement('tr'), addRow);
            row.innerHTML = `
                <td><input type="checkbox" class="row-select" aria-label="Select row" /></td>
                <td data-col="index">0</td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}"></textarea></div></td>
                <td><span class="status-badge status-pending" data-status="pending">${t('status_pending') || 'PENDING'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                        <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            row.querySelectorAll('textarea').forEach(autoResizeTextarea);
            wireRowCheckbox(row);
            applyTranslations();
            renumberRows();
            pushTableHistory();
        }
        
        function addRowAfter(button) {
            const currentRow = button.parentElement.parentElement;
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            const newRow = tbody.insertBefore(document.createElement('tr'), addRow);
            newRow.innerHTML = `
                <td><input type="checkbox" class="row-select" aria-label="Select row" /></td>
                <td data-col="index">0</td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}"></textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}"></textarea></div></td>
                <td><span class="status-badge status-pending" data-status="pending">${t('status_pending') || 'PENDING'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                        <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            newRow.querySelectorAll('textarea').forEach(autoResizeTextarea);
            wireRowCheckbox(newRow);
            applyTranslations();
            renumberRows();
            pushTableHistory();
        }
        
        function copyRow(button) {
            const currentRow = button.closest('tr');
            duplicateRow(currentRow);
            pushTableHistory();
        }
        
        function sendFromRow(button) {
            const row = button.closest('tr');
            const cells = row.cells;
            const countryCode = getCellValue(cells[2]);
            const phone = getCellValue(cells[3]);
            const name = getCellValue(cells[4]);
            const message = document.getElementById('messageEditor').value || '';
            if (!message.trim()) {
                showStatus(t('message_required'), true);
                return;
            }
            setRowStatus(row, 'pending');
            sendMessage(phone, message, countryCode, name, row);
        }
        
        function deleteRow(button) {
            const row = button.closest('tr');
            row.remove();
            renumberRows();
            updateSelectAllCheckbox();
            pushTableHistory();
        }
        
        function importFile() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            fetch('/upload', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    populateTable(data.data);
                }
            });
        }
        
        function populateTable(data) {
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            let firstMessage = '';
            let firstFileLink = '';
            // Limpiar filas dinámicas
            while (tbody.firstChild !== addRow) {
                tbody.removeChild(tbody.firstChild);
            }
            data.forEach(item => {
                if (!firstMessage && item.message) {
                    firstMessage = item.message;
                }
                if (!firstFileLink && item.file_link) {
                    firstFileLink = item.file_link;
                }
                const row = tbody.insertBefore(document.createElement('tr'), addRow);
                row.innerHTML = `
                    <td><input type="checkbox" class="row-select" aria-label="Select row" /></td>
                    <td data-col="index">0</td>
                    <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}">${item.country_code || ''}</textarea></div></td>
                    <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}">${item.phone || ''}</textarea></div></td>
                    <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}">${item.name || ''}</textarea></div></td>
                    <td><span class="status-badge status-pending" data-status="pending">${t('status_pending') || 'PENDING'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                            <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                            <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
                row.querySelectorAll('textarea').forEach(autoResizeTextarea);
                wireRowCheckbox(row);
            });
            const editor = document.getElementById('messageEditor');
            if (editor && !editor.value && firstMessage) {
                editor.value = firstMessage;
                document.getElementById('editorCharCount').textContent = editor.value.length;
            }
            if (firstFileLink) {
                renderFileList();
            }
            applyTranslations();
            renumberRows();
            updateSelectAllCheckbox();
            pushTableHistory();
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function sendAll() {
            if (isSending) {
                showStatus(t('sending_in_progress'), false, true);
                return;
            }
            const rows = Array.from(document.querySelectorAll('#tableBody tr')).filter(row => row.id !== 'addRow');
            const contacts = rows.map(row => {
                const cells = row.cells;
                const countryCode = getCellValue(cells[2]);
                const phone = getCellValue(cells[3]);
                const name = getCellValue(cells[4]);
                return {
                    row_index: row.dataset.rowIndex ? parseInt(row.dataset.rowIndex, 10) : null,
                    country_code: countryCode,
                    phone: phone,
                    name: name
                };
            }).filter(contact => contact.phone);
            rows.forEach(row => setRowStatus(row, 'pending'));

            const message = document.getElementById('messageEditor').value || '';
            if (!message.trim()) {
                showStatus(t('message_required'), true);
                return;
            }
            
            const minInterval = parseFloat(document.getElementById('intervalMin').value) || 1;
            const maxInterval = parseFloat(document.getElementById('intervalMax').value) || 2;
            
            isSending = true;
            const total = contacts.length;
            let sent = 0;
            let error = 0;
            let skipped = 0;
            let index = 0;
            showStatus(`${t('sending')} 0 ${t('of')} ${total}`, false, true);
            for (const contact of contacts) {
                index += 1;
                const row = rows.find(r => parseInt(r.dataset.rowIndex, 10) === contact.row_index);
                if (!contact.phone) {
                    skipped += 1;
                    if (row) setRowStatus(row, 'skipped');
                    showStatus(`${t('sending')} ${index} ${t('of')} ${total}`, false, true);
                    continue;
                }
                try {
                    const response = await sendPayload('/send', {
                        phone: contact.phone,
                        message,
                        country_code: contact.country_code,
                        name: contact.name,
                        row_index: contact.row_index
                    });
                    const text = await response.text();
                    let data = {};
                    try { data = JSON.parse(text); } catch (_) { data = { error: text || 'Server error' }; }
                    if (!response.ok && !data.error) {
                        data.error = `HTTP ${response.status}`;
                    }
                    if (data.error) {
                        error += 1;
                        if (row) setRowStatus(row, 'error', localizeError(data));
                    } else {
                        sent += 1;
                        if (row) setRowStatus(row, 'sent');
                    }
                } catch (err) {
                    error += 1;
                    if (row) setRowStatus(row, 'error', t('error_connect'));
                }
                showStatus(`${t('sending')} ${index} ${t('of')} ${total}`, false, true);
                if (index < total) {
                    const wait = (Math.random() * (maxInterval - minInterval) + minInterval) * 1000;
                    await sleep(wait);
                }
            }
            const summary = t('send_summary')
                .replace('{sent}', sent)
                .replace('{error}', error)
                .replace('{skipped}', skipped);
            showStatus(summary, error > 0);
            isSending = false;
        }
        
        function insertFormat(format) {
            const textarea = document.getElementById('messageEditor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            const before = text.substring(0, start);
            const selected = text.substring(start, end);
            const after = text.substring(end);

            const hasWrapping =
                start >= format.length &&
                end + format.length <= text.length &&
                text.substring(start - format.length, start) === format &&
                text.substring(end, end + format.length) === format;

            if (hasWrapping) {
                textarea.value =
                    text.substring(0, start - format.length) +
                    selected +
                    text.substring(end + format.length);
                textarea.focus();
                textarea.setSelectionRange(start - format.length, end - format.length);
            } else {
                const formatted = `${format}${selected}${format}`;
                textarea.value = before + formatted + after;
                textarea.focus();
                textarea.setSelectionRange(start + format.length, end + format.length);
            }

            document.getElementById('editorCharCount').textContent = textarea.value.length;
        }

        function insertNameToken() {
            const textarea = document.getElementById('messageEditor');
            const token = '{name}';
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end);
            textarea.value = before + token + after;
            textarea.focus();
            const caret = start + token.length;
            textarea.setSelectionRange(caret, caret);
            document.getElementById('editorCharCount').textContent = textarea.value.length;
            scheduleMessageHistory();
        }
        
        function sendMessage(phone, message, countryCode, name, row) {
            if (isSending) {
                showStatus(t('sending_in_progress'), false, true);
                return;
            }
            isSending = true;
            showStatus(`${t('sending')} 1 ${t('of')} 1`, false, true);
            sendPayload('/send', { phone, message, country_code: countryCode, name, row_index: row ? parseInt(row.dataset.rowIndex, 10) : null })
            .then(async response => {
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text); } catch (_) { data = { error: text || 'Server error' }; }
                if (!response.ok && !data.error) {
                    data.error = `HTTP ${response.status}`;
                }
                return data;
            })
            .then(data => {
                if (data.error) {
                    const message = localizeError(data);
                    showStatus(message, true);
                    if (row) setRowStatus(row, 'error', message);
                } else {
                    showStatus(data.status || 'OK', false);
                    if (row) setRowStatus(row, 'sent');
                }
            })
            .catch(() => {
                showStatus(t('error_connect'), true);
            })
            .finally(() => {
                isSending = false;
            });
        }
        
        function exportResults() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr')).filter(row => row.id !== 'addRow');
            const headers = [
                t('country_code'),
                t('phone_number'),
                t('name')
            ];
            let csv = `${headers.join(',')}\n`;
            rows.forEach(row => {
                const cells = row.cells;
                if (!cells || cells.length < 4) return;
                const countryCode = getCellValue(cells[2]);
                const phone = getCellValue(cells[3]);
                const name = getCellValue(cells[4]);
                csv += `"${countryCode}","${phone}","${name}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contacts.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
        
        function openWhatsApp() {
            window.open('https://web.whatsapp.com', '_blank');
        }

        function sendPayload(url, payload, files) {
            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        function normaliseNumeric(value) {
            return String(value || '').replace(/\D+/g, '');
        }

        function getDataRows() {
            return Array.from(tableBody.querySelectorAll('tr')).filter(r => r.id !== 'addRow');
        }

        function wireRowCheckbox(row) {
            const checkbox = row.querySelector('input.row-select');
            if (!checkbox || checkbox.dataset.wired) return;
            checkbox.dataset.wired = 'true';
            checkbox.addEventListener('change', updateSelectAllCheckbox);
        }

        function updateSelectAllCheckbox() {
            if (!selectAllRowsCheckbox) return;
            const rows = getDataRows();
            if (!rows.length) {
                selectAllRowsCheckbox.checked = false;
                selectAllRowsCheckbox.indeterminate = false;
                return;
            }
            const checked = rows.filter(row => row.querySelector('input.row-select')?.checked);
            selectAllRowsCheckbox.checked = checked.length === rows.length;
            selectAllRowsCheckbox.indeterminate = checked.length > 0 && checked.length < rows.length;
        }

        function getSelectedRows() {
            return getDataRows().filter(row => row.querySelector('input.row-select')?.checked);
        }

        function getTargetRowsForBulk() {
            const selected = getSelectedRows();
            return selected.length ? selected : getDataRows();
        }

        function getTableState() {
            return getDataRows().map(row => {
                const cells = row.cells;
                const badge = row.querySelector('.status-badge');
                return {
                    country_code: normaliseNumeric(getCellValue(cells[2])),
                    phone: normaliseNumeric(getCellValue(cells[3])),
                    name: getCellValue(cells[4]),
                    status: badge?.dataset.status || 'pending'
                };
            });
        }

        function applyTableState(state) {
            isRestoringHistory = true;
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            while (tbody.firstChild !== addRow) {
                tbody.removeChild(tbody.firstChild);
            }
            state.forEach(item => {
                const status = item.status || 'pending';
                const statusLabel = t(`status_${status}`) || status.toUpperCase();
                const row = tbody.insertBefore(document.createElement('tr'), addRow);
                row.innerHTML = `
                    <td><input type="checkbox" class="row-select" aria-label="Select row" /></td>
                    <td data-col="index">0</td>
                    <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_country" placeholder="${t('placeholder_country')}">${normaliseNumeric(item.country_code)}</textarea></div></td>
                    <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true" data-i18n-placeholder="placeholder_phone" placeholder="${t('placeholder_phone')}">${normaliseNumeric(item.phone)}</textarea></div></td>
                    <td><div class="cell-input"><textarea rows="1" data-i18n-placeholder="placeholder_name" placeholder="${t('placeholder_name')}">${item.name || ''}</textarea></div></td>
                    <td><span class="status-badge status-${status}" data-status="${status}">${statusLabel}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                            <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                            <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
                row.querySelectorAll('textarea').forEach(autoResizeTextarea);
                wireRowCheckbox(row);
            });
            applyTranslations();
            renumberRows();
            updateSelectAllCheckbox();
            isRestoringHistory = false;
        }

        function pushTableHistory() {
            if (isRestoringHistory) return;
            const state = getTableState();
            const last = tableHistory[historyIndex];
            const snapshot = JSON.stringify(state);
            if (last && JSON.stringify(last) === snapshot) return;
            tableHistory.splice(historyIndex + 1);
            tableHistory.push(state);
            historyIndex = tableHistory.length - 1;
            updateHistoryButtons();
        }

        function scheduleHistoryCapture() {
            if (isRestoringHistory) return;
            if (historyTimer) window.clearTimeout(historyTimer);
            historyTimer = window.setTimeout(() => {
                pushTableHistory();
                historyTimer = null;
            }, 300);
        }

        function commitHistoryNow() {
            if (historyTimer) {
                window.clearTimeout(historyTimer);
                historyTimer = null;
            }
            pushTableHistory();
        }

        function updateHistoryButtons() {
            if (!undoBtn || !redoBtn) return;
            if (activeArea === 'message') {
                undoBtn.disabled = messageHistoryIndex <= 0;
                redoBtn.disabled = messageHistoryIndex >= messageHistory.length - 1;
                return;
            }
            if (activeArea === 'files') {
                undoBtn.disabled = fileHistoryIndex <= 0;
                redoBtn.disabled = fileHistoryIndex >= fileHistory.length - 1;
                return;
            }
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= tableHistory.length - 1;
        }

        function undoTable() {
            commitHistoryNow();
            if (historyIndex <= 0) return;
            historyIndex -= 1;
            applyTableState(tableHistory[historyIndex]);
            updateHistoryButtons();
        }

        function redoTable() {
            commitHistoryNow();
            if (historyIndex >= tableHistory.length - 1) return;
            historyIndex += 1;
            applyTableState(tableHistory[historyIndex]);
            updateHistoryButtons();
        }

        function getMessageState() {
            return messageEditor ? messageEditor.value : '';
        }

        function applyMessageState(value) {
            if (!messageEditor) return;
            isRestoringMessage = true;
            messageEditor.value = value || '';
            document.getElementById('editorCharCount').textContent = messageEditor.value.length;
            isRestoringMessage = false;
        }

        function pushMessageHistory() {
            if (isRestoringMessage) return;
            const value = getMessageState();
            const last = messageHistory[messageHistoryIndex];
            if (last === value) return;
            messageHistory.splice(messageHistoryIndex + 1);
            messageHistory.push(value);
            messageHistoryIndex = messageHistory.length - 1;
            updateHistoryButtons();
        }

        function scheduleMessageHistory() {
            if (isRestoringMessage) return;
            if (messageHistoryTimer) window.clearTimeout(messageHistoryTimer);
            messageHistoryTimer = window.setTimeout(() => {
                pushMessageHistory();
                messageHistoryTimer = null;
            }, 300);
        }

        function commitMessageHistoryNow() {
            if (messageHistoryTimer) {
                window.clearTimeout(messageHistoryTimer);
                messageHistoryTimer = null;
            }
            pushMessageHistory();
        }

        function undoMessage() {
            commitMessageHistoryNow();
            if (messageHistoryIndex <= 0) return;
            messageHistoryIndex -= 1;
            applyMessageState(messageHistory[messageHistoryIndex]);
            updateHistoryButtons();
        }

        function redoMessage() {
            commitMessageHistoryNow();
            if (messageHistoryIndex >= messageHistory.length - 1) return;
            messageHistoryIndex += 1;
            applyMessageState(messageHistory[messageHistoryIndex]);
            updateHistoryButtons();
        }

        function getFileState() {
            return [...selectedFileIds];
        }

        function applyFileState(values) {
            if (!fileRowsContainer) return;
            isRestoringFiles = true;
            selectedFileIds = Array.isArray(values) ? values.filter(id => fileStore.has(id)) : [];
            renderFileList();
            isRestoringFiles = false;
        }

        function pushFileHistory() {
            if (isRestoringFiles) return;
            const values = getFileState();
            const last = fileHistory[fileHistoryIndex];
            if (last && JSON.stringify(last) === JSON.stringify(values)) return;
            fileHistory.splice(fileHistoryIndex + 1);
            fileHistory.push(values);
            fileHistoryIndex = fileHistory.length - 1;
            updateHistoryButtons();
        }

        function scheduleFileHistory() {
            if (isRestoringFiles) return;
            if (fileHistoryTimer) window.clearTimeout(fileHistoryTimer);
            fileHistoryTimer = window.setTimeout(() => {
                pushFileHistory();
                fileHistoryTimer = null;
            }, 300);
        }

        function commitFileHistoryNow() {
            if (fileHistoryTimer) {
                window.clearTimeout(fileHistoryTimer);
                fileHistoryTimer = null;
            }
            pushFileHistory();
        }

        function undoFiles() {
            commitFileHistoryNow();
            if (fileHistoryIndex <= 0) return;
            fileHistoryIndex -= 1;
            applyFileState(fileHistory[fileHistoryIndex]);
            updateHistoryButtons();
        }

        function redoFiles() {
            commitFileHistoryNow();
            if (fileHistoryIndex >= fileHistory.length - 1) return;
            fileHistoryIndex += 1;
            applyFileState(fileHistory[fileHistoryIndex]);
            updateHistoryButtons();
        }

        function undoAction() {
            if (activeArea === 'message') return undoMessage();
            if (activeArea === 'files') return undoFiles();
            return undoTable();
        }

        function redoAction() {
            if (activeArea === 'message') return redoMessage();
            if (activeArea === 'files') return redoFiles();
            return redoTable();
        }

        function getCellCoords(cell) {
            const row = cell.parentElement;
            const rows = getDataRows();
            const rowIndex = rows.indexOf(row);
            const colIndex = Array.from(row.children).indexOf(cell);
            return { rowIndex, colIndex };
        }

        function getCellAt(rowIndex, colIndex) {
            const rows = getDataRows();
            if (rowIndex < 0 || rowIndex >= rows.length) return null;
            const cells = rows[rowIndex].children;
            if (colIndex < 0 || colIndex >= cells.length) return null;
            return cells[colIndex];
        }

        function clearSelection() {
            tableBody.querySelectorAll('td.selected').forEach(cell => cell.classList.remove('selected'));
        }

        function selectRange(fromCell, toCell) {
            clearSelection();
            if (!fromCell || !toCell) return;
            const from = getCellCoords(fromCell);
            const to = getCellCoords(toCell);
            const rMin = Math.min(from.rowIndex, to.rowIndex);
            const rMax = Math.max(from.rowIndex, to.rowIndex);
            const cMin = Math.min(from.colIndex, to.colIndex);
            const cMax = Math.max(from.colIndex, to.colIndex);
            for (let r = rMin; r <= rMax; r += 1) {
                for (let c = cMin; c <= cMax; c += 1) {
                    const cell = getCellAt(r, c);
                    if (cell) cell.classList.add('selected');
                }
            }
        }

        function selectAllRows() {
            const rows = getDataRows();
            if (!rows.length) return;
            rows.forEach(row => {
                const checkbox = row.querySelector('input.row-select');
                if (checkbox) checkbox.checked = true;
            });
            updateSelectAllCheckbox();
        }

        async function copyAllRows() {
            const rows = getTargetRowsForBulk();
            if (!rows.length) return;
            rows.forEach(row => duplicateRow(row));
            pushTableHistory();
        }

        function deleteAllRows() {
            const rows = getTargetRowsForBulk();
            if (!rows.length) return;
            rows.forEach(row => row.remove());
            renumberRows();
            updateSelectAllCheckbox();
            pushTableHistory();
        }

        function duplicateRow(sourceRow) {
            if (!sourceRow) return;
            const cells = sourceRow.cells;
            const tbody = document.getElementById('tableBody');
            const addRow = document.getElementById('addRow');
            const newRow = tbody.insertBefore(document.createElement('tr'), addRow);
            newRow.innerHTML = `
                <td><input type="checkbox" class="row-select" aria-label="Select row" /></td>
                <td data-col="index">0</td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true">${getCellValue(cells[2])}</textarea></div></td>
                <td><div class="cell-input"><textarea rows="1" inputmode="numeric" pattern="\d*" data-numeric="true">${getCellValue(cells[3])}</textarea></div></td>
                <td><div class="cell-input"><textarea rows="1">${getCellValue(cells[4])}</textarea></div></td>
                <td><span class="status-badge status-pending" data-status="pending">${t('status_pending') || 'PENDING'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button onclick="sendFromRow(this)" data-i18n="send" data-i18n-attr="title,aria-label" title="${t('send')}" aria-label="${t('send')}">
                            <i class="fa-brands fa-whatsapp"></i>
                        </button>
                        <button onclick="copyRow(this)" data-i18n="copy" data-i18n-attr="title,aria-label" title="${t('copy')}" aria-label="${t('copy')}">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        <button onclick="deleteRow(this)" data-i18n="delete" data-i18n-attr="title,aria-label" title="${t('delete')}" aria-label="${t('delete')}">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            `;
            newRow.querySelectorAll('textarea').forEach(autoResizeTextarea);
            wireRowCheckbox(newRow);
            applyTranslations();
            renumberRows();
            updateSelectAllCheckbox();
        }

        if (selectAllRowsCheckbox) {
            selectAllRowsCheckbox.addEventListener('change', () => {
                const rows = getDataRows();
                rows.forEach(row => {
                    const checkbox = row.querySelector('input.row-select');
                    if (checkbox) checkbox.checked = selectAllRowsCheckbox.checked;
                });
                updateSelectAllCheckbox();
            });
        }

        const tableObserver = new MutationObserver(() => {
            scheduleHistoryCapture();
        });
        tableObserver.observe(tableBody, { childList: true, subtree: true });

        pushTableHistory();
        updateHistoryButtons();
        pushMessageHistory();
        pushFileHistory();

        tableBody.addEventListener('mousedown', (event) => {
            if (event.target.closest('input, textarea')) {
                return;
            }
            const cell = event.target.closest('td');
            if (!cell || cell.parentElement.id === 'addRow') return;
            isDragging = true;
            if (event.shiftKey && anchorCell) {
                selectRange(anchorCell, cell);
            } else {
                anchorCell = cell;
                selectRange(cell, cell);
            }
        });

        tableBody.addEventListener('mouseover', (event) => {
            if (!isDragging) return;
            const cell = event.target.closest('td');
            if (!cell || cell.parentElement.id === 'addRow') return;
            selectRange(anchorCell, cell);
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        async function copySelectionToClipboard() {
            const selected = Array.from(tableBody.querySelectorAll('td.selected'));
            if (selected.length === 0) return;
            const coords = selected.map(getCellCoords);
            const rMin = Math.min(...coords.map(c => c.rowIndex));
            const rMax = Math.max(...coords.map(c => c.rowIndex));
            const cMin = Math.min(...coords.map(c => c.colIndex));
            const cMax = Math.max(...coords.map(c => c.colIndex));
            const lines = [];
            for (let r = rMin; r <= rMax; r += 1) {
                const rowVals = [];
                for (let c = cMin; c <= cMax; c += 1) {
                    const cell = getCellAt(r, c);
                    if (!cell) {
                        rowVals.push('');
                        continue;
                    }
                    const input = cell.querySelector('input, textarea');
                    rowVals.push(input ? input.value : cell.textContent.trim());
                }
                lines.push(rowVals.join('\t'));
            }
            const text = lines.join('\n');
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                textarea.remove();
            }
        }

        async function pasteFromClipboard() {
            if (!anchorCell) return;
            let text = '';
            if (navigator.clipboard && navigator.clipboard.readText) {
                text = await navigator.clipboard.readText();
            }
            if (!text) return;
            const rows = text.split(/\r?\n/);
            const start = getCellCoords(anchorCell);
            rows.forEach((rowText, rIndex) => {
                const cols = rowText.split('\t');
                cols.forEach((val, cIndex) => {
                    const cell = getCellAt(start.rowIndex + rIndex, start.colIndex + cIndex);
                    if (!cell) return;
                    const input = cell.querySelector('input, textarea');
                    if (input) {
                        if (input.matches('textarea[data-numeric="true"]')) {
                            input.value = normaliseNumeric(val);
                        } else {
                            input.value = val;
                        }
                    }
                });
            });
            scheduleHistoryCapture();
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }

        document.addEventListener('input', (event) => {
            const textarea = event.target.closest('textarea');
            if (textarea && textarea.closest('#dataTable')) {
                autoResizeTextarea(textarea);
                scheduleHistoryCapture();
            }
        });

        document.querySelectorAll('#dataTable textarea').forEach(autoResizeTextarea);

        document.addEventListener('focusin', (event) => {
            if (event.target === messageEditor) {
                activeArea = 'message';
                updateHistoryButtons();
                return;
            }
            if (event.target.closest && event.target.closest('#fileRows')) {
                activeArea = 'files';
                updateHistoryButtons();
                return;
            }
            if (event.target.closest && event.target.closest('#dataTable')) {
                activeArea = 'table';
                updateHistoryButtons();
            }
        });

        document.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c') {
                copySelectionToClipboard();
            }
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'v') {
                pasteFromClipboard();
            }
            const inTable = event.target.closest && event.target.closest('#dataTable');
            const inMessage = event.target === messageEditor;
            const inFiles = event.target.closest && event.target.closest('#fileRows');
            if (inMessage) activeArea = 'message';
            if (inFiles) activeArea = 'files';
            if (inTable) activeArea = 'table';
            if ((event.ctrlKey || event.metaKey) && (inTable || inMessage || inFiles)) {
                const key = event.key.toLowerCase();
                if (key === 'z') {
                    event.preventDefault();
                    if (event.shiftKey) {
                        redoAction();
                    } else {
                        undoAction();
                    }
                }
                if (key === 'y') {
                    event.preventDefault();
                    redoAction();
                }
            }
        });

        document.addEventListener('input', (event) => {
            const field = event.target.closest('textarea[data-numeric="true"]');
            if (!field) return;
            const cleaned = field.value.replace(/\D+/g, '');
            if (cleaned !== field.value) {
                const pos = field.selectionStart;
                field.value = cleaned;
                field.setSelectionRange(Math.min(pos, cleaned.length), Math.min(pos, cleaned.length));
                scheduleHistoryCapture();
            }
        });
    </script>
</body>
</html>
